

<p-panel header="Deklaracje czasu pracy">

  <div class="ui-grid-row">
    <div class="ui-grid-col-7">
      <p-fieldset legend="Listy obecności">
        <form #f="ngForm" (submit)="search()">

          <div class="ui-grid ui-grid-responsive ui-fluid ui-grid-pad">
            <div class="ui-grid-row"  style="margin-top: 20px;">
              <div class="ui-grid-col-1"><label style="float: right" for="afterDate">Od</label></div>
              <div class="ui-grid-col-3">
                <!--<p-calendar id="date" name="reportDate" (onSelect)="search()" [(ngModel)]="reportDate" showIcon="true" dateFormat="dd.mm.yy" utc="true"></p-calendar>-->
                <p-calendar id="afterDate" name="afterDate" [locale]="pl" [(ngModel)]="afterDate" showIcon="true" dateFormat="dd.mm.yy" utc="true"></p-calendar>
              </div>
              <div class="ui-grid-col-1"><label style="float: right" for="beforeDate">Do</label></div>
              <div class="ui-grid-col-3">
                <!--<p-calendar id="date" name="reportDate" (onSelect)="search()" [(ngModel)]="reportDate" showIcon="true" dateFormat="dd.mm.yy" utc="true"></p-calendar>-->
                <p-calendar id="beforeDate" name="beforeDate" [locale]="pl" [(ngModel)]="beforeDate" showIcon="true" dateFormat="dd.mm.yy" utc="true"></p-calendar>
              </div>
              <div class="ui-grid-col-4">
                <button pButton type="button" (click)="search()" icon="fa fa-search" label="Szukaj" style="margin-left: 0px; min-width: 140px; max-width: 200px;" [disabled]="!f?.valid"></button>
              </div>
            </div>
          </div>

        </form>
      </p-fieldset>
    </div>
    <div *ngIf="user.roleCode.indexOf('OP') != -1" class="ui-grid-col-3">
      <p-fieldset legend="Urlopy">
        <user-leave *ngIf="users?.length > 0" [users]="users"></user-leave>
      </p-fieldset>
    </div>
    <div *ngIf="user.roleCode.indexOf('OP') != -1 || user.roleCode.indexOf('MG') != -1" class="ui-grid-col-2">
      <p-fieldset legend="Raporty miesięczne">
        <button pButton type="button" (click)="router.navigate(['/timeStats'])" icon="fa fa-search" label="Podsumowanie" style="margin-top: 30px; margin-left: 0px; min-width: 140px; max-width: 200px;"></button>
      </p-fieldset>
    </div>
  </div>

  <div class="ui-g" *ngIf="usersWithSheets" style="margin-top: 5px; margin-right: 10px;">
    <p-dataTable 
    [editable]="true" 
    (onEditInit)="onEditInit($event)" 
    (onEdit)="onEdit($event)" 
    (onEditCancel)="onEditCancel($event)" 
    (onEditComplete)="onEditComplete($event)"
     [value]="usersWithSheets"
      [rows]="20" [paginator]="true" [globalFilter]="gb" #dt dataKey="tabid" resizableColumns="true" sortField="lastName" sortOrder="1" 
      [loading]="loading" loadingIcon="fa fa-spinner"
                 csvSeparator=";" exportFilename="czas_pracy"
                 expandableRows="true">
      <p-header>
        <div>
          <i class="fa fa-search"></i>
          <input #gb type="text" pInputText size="50" placeholder="Filtruj">
        </div>
      </p-header>

      <p-column expander="true" styleClass="col-icon" [style]="{'width': '30px'}"></p-column>
      <p-column [sortable]="true" field="rowid" header="tabid" hidden="true" [exportable]="false"></p-column>
      <p-column [sortable]="true" field="office" header="Biuro" [filter]="true" filterPlaceholder="Filtruj"></p-column>
      <p-column [sortable]="true" field="firstName" header="Imie"  [filter]="true" filterPlaceholder="Filtruj"></p-column>
      <p-column [sortable]="true" field="lastName" header="Nazwisko"  [filter]="true" filterPlaceholder="Filtruj"></p-column>
      <p-column [hidden]="true" [sortable]="true" field="isManagerOrOperator" header=""  [filter]="true" filterPlaceholder="Filtruj"></p-column>

      <p-column [sortable]="true" field="copy.fromMobileDevice" header="Wejście" [filter]="true" filterPlaceholder="Y/N" [style]="{'width': '60px'}">
        <ng-template let-col let-timesheet="rowData" pTemplate="body">
          <div *ngIf="timesheet.copy.fromMobileDevice === 'Y'"  class="text-center" [style.color]="'darkred'"><i class="fa fa-mobile-phone" aria-hidden="true"></i></div>
          <div *ngIf="timesheet.copy.fromMobileDevice === 'N'"  class="text-center" [style.color]="'green'"><i class="fa fa-laptop" aria-hidden="true"></i></div>
        </ng-template>
      </p-column>

      <p-column [sortable]="true" field="copy.toMobileDevice" header="Wyjście" [filter]="true" filterPlaceholder="Y/N" [style]="{'width': '60px'}">
        <ng-template let-col let-timesheet="rowData" pTemplate="body">
          <div *ngIf="timesheet.copy.toMobileDevice === 'Y'"  class="text-center" [style.color]="'darkred'"><i class="fa fa-mobile-phone" aria-hidden="true"></i></div>
          <div *ngIf="timesheet.copy.toMobileDevice === 'N'"  class="text-center" [style.color]="'green'"><i class="fa fa-laptop" aria-hidden="true"></i></div>
        </ng-template>
      </p-column>

      <p-column [sortable]="true" field="timesheetWorkDate" header="Dnia" [filter]="true" filterPlaceholder="Filtruj">
        <ng-template let-col let-timesheet="rowData" pTemplate="body">
          <div [style.color]="timesheet.color" class="text-center">{{timesheet.timesheetWorkDate}}</div>
        </ng-template>
      </p-column>

      <p-column [editable]="user?.roleCode?.indexOf('OP') > -1" [sortable]="true" header="Urlop" field="isLeave" [style]="{'width': '70px'}" [filter]="true" filterPlaceholder="Filtruj">
        <ng-template let-col let-timesheet="rowData" pTemplate="body">
          <div [style.color]="timesheet.color" class="text-center">{{timesheet.isLeave}}</div>
        </ng-template>
      </p-column>

      <p-column [editable]="user?.roleCode?.indexOf('OP') > -1" [sortable]="true" header="Obecny od" field="timesheetFrom" [filter]="true" filterPlaceholder="Filtruj">
        <ng-template let-col let-timesheet="rowData" pTemplate="body">
          <div [style.color]="timesheet.color" class="text-center">{{timesheet.timesheetFrom}}</div>
        </ng-template>
      </p-column>

      <p-column [editable]="user?.roleCode?.indexOf('OP') > -1" [sortable]="true" header="Obecny do" field="timesheetTo" [filter]="true" filterPlaceholder="Filtruj">
        <ng-template let-col let-timesheet="rowData" pTemplate="body">
          <div [style.color]="timesheet.color" class="text-center">{{timesheet.timesheetTo}}</div>
        </ng-template>
      </p-column>

      <p-column [editable]="user?.roleCode?.indexOf('OP') > -1" [sortable]="true" header="Przerwa [min]" field="timesheetBreakInMinutes" [filter]="true" filterPlaceholder="Filtruj">
        <ng-template let-col let-timesheet="rowData" pTemplate="body">
          <div [style.color]="timesheet.color" class="text-center">{{timesheet.timesheetBreakInMinutes}}</div>
        </ng-template>
      </p-column>

      <p-column [editable]="user?.roleCode?.indexOf('OP') > -1" [sortable]="true" header="Szkolenie [g:mm]" field="timesheetTrainingInGMM" [filter]="true" filterPlaceholder="Filtruj">
        <ng-template let-col let-timesheet="rowData" pTemplate="body">
          <div [style.color]="timesheet.color" class="text-center">{{timesheet.timesheetTrainingInGMM}}</div>
        </ng-template>
      </p-column>

      <p-column [sortable]="true" field="timesheetUsedTime" header="Obecność" [filter]="true" filterPlaceholder="Filtruj">
        <ng-template let-col let-timesheet="rowData" pTemplate="body">
          <div [style.color]="timesheet.color" class="text-center">{{timesheet.timesheetUsedTime}}</div>
        </ng-template>
      </p-column>

      <p-column *ngIf="user?.roleCode?.indexOf('OP') > -1" [sortable]="true" field="status" header="Zapisano" [style]="{'width': '60px'}">
        <ng-template let-col let-timesheet="rowData" pTemplate="body">
          <div *ngIf="timesheet.status == 'PROGRESS'"  class="text-center"><p-progressSpinner [style]="{width: '30px', height: '30px'}" strokeWidth="2"></p-progressSpinner></div>
          <div *ngIf="timesheet.status == 'OK'"  class="text-center" [style.color]="'green'"><i class="fa fa-check" aria-hidden="true"></i></div>
          <div *ngIf="timesheet.status == 'EDITED'" class="text-center" [style.color]="'#2399e5'"><i class="fa fa-pencil-square-o" aria-hidden="true"></i></div>
        </ng-template>
      </p-column>

      <ng-template let-timesheet pTemplate="rowexpansion">
        <div class="ui-grid ui-grid-responsive ui-fluid" style="font-size:16px;padding:20px">
          <div class="ui-grid-row">
            <div *ngIf="timesheet?.email" class="ui-grid-col-12" style="text-align:left; font-size: smaller;">
              Utworzony dla: {{timesheet.role}}, {{timesheet.email}}, {{timesheet.phone}},
            </div>
          </div>
          <div class="ui-grid-row">
            <div *ngIf="timesheet?.copy?.createdBy" class="ui-grid-col-12" style="text-align:left; font-size: smaller;">
                Utworzony przez: <span style="font-weight: bold">{{timesheet.copy.createdBy}}</span>
            </div>
          </div>
          <div class="ui-grid-row">
            <div *ngIf="timesheet?.copy?.modifiedBy" class="ui-grid-col-12" style="text-align:left; font-size: smaller;">
                Zmodyfikowany przez: <span style="font-weight: bold">{{timesheet.copy.modifiedBy}}</span>
            </div>
          </div>
          <div class="ui-grid-row">
            <div *ngIf="timesheet?.copy?.fromIsp || timesheet?.copy?.fromOrg" class="ui-grid-col-12" style="text-align:left; font-size: smaller;">
              Wejście: <span style="font-weight: bold">{{timesheet.copy.fromIsp}} @ {{timesheet.copy.fromOrg}}, {{timesheet.copy.fromCity}} @ {{timesheet.copy.fromRegion}}</span>
            </div>
          </div>
          <div class="ui-grid-row">
            <div *ngIf="timesheet?.copy?.toIsp || timesheet?.copy?.toOrg" class="ui-grid-col-12" style="text-align:left; font-size: smaller;">
              Wyjście: <span style="font-weight: bold">{{timesheet.copy.toIsp}} @ {{timesheet.copy.toOrg}}, {{timesheet.copy.toCity}} @ {{timesheet.copy.toRegion}}</span>
            </div>
          </div>
        </div>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        Brak danych...
      </ng-template>

      <p-footer>
        <div class="ui-grid ui-grid-responsive ui-fluid ui-grid-pad">
          <div  *ngIf="user?.roleCode?.indexOf('OP') > -1" class="ui-grid-row"  style="margin-top: 15px;">
            <div class="ui-grid-col-5"></div>
            <div class="ui-grid-col-2">
           
              <button type="button" pButton icon="fa fa-file-o" iconPos="left" label="CSV" (click)="dt.exportCSV()"></button>
            </div>
            <div class="ui-grid-col-5"></div>
          </div>
        </div>
      </p-footer>

    </p-dataTable>

    <!-- turbo table  -->
<!-- <p-table #tt [value]="usersWithSheets" [columns]="cols" dataKey="tabid"
      [rows]="20" [paginator]="true"
      [resizableColumns]="true" sortOrder="1"  
>
    <ng-template pTemplate="caption">
        <div>
          <i class="fa fa-search"></i>
          <input type="text" pInputText size="50" placeholder="Filtruj"
            (input)="tt.filterGlobal($event.target.value, 'contains')" style="width:auto">
        </div>
      </ng-template>
  <ng-template pTemplate="body" let-rowData let-columns="columns" let-expanded="expanded">
    <tr>       
     <td *ngFor="let col of columns" [pEditableColumn]="rowData"  [pEditableColumnField]="rowData[col.field]"
     [hidden]="col.hidden" [ngClass]="col.class">
         <p-cellEditor *ngIf="col.edit">  
             <ng-template pTemplate="input">
                 <input pInputText type="text" [(ngModel)]="rowData[col.field]" (ngModelChange)="valueChange(rowData)" [style.color]="rowData.color">
             </ng-template>
             <ng-template pTemplate="output">
               <span [style.color]="rowData.color" >
                   {{rowData[col.field]}}
               </span>
             </ng-template>
           </p-cellEditor>
           <span  *ngIf="!col.edit && !col.status">
               {{rowData[col.field]}}
           </span>
           <div *ngIf="col.status">
               <div *ngIf="rowData[col.field] == 'PROGRESS'"  class="text-center"><p-progressSpinner [style]="{width: '30px', height: '30px'}" strokeWidth="2"></p-progressSpinner></div>
               <div *ngIf="rowData[col.field] == 'OK'"  class="text-center" [style.color]="'green'"><i class="fa fa-check" aria-hidden="true"></i></div>
               <div *ngIf="rowData[col.field] == 'EDITED'" class="text-center" [style.color]="'#2399e5'"><i class="fa fa-pencil-square-o" aria-hidden="true"></i></div>    
           </div>
           <div *ngIf="col.expand">
               <a href="#" [pRowToggler]="rowData">
                   <i [ngClass]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></i>
               </a>
           </div>
     </td>
   </tr> 
 </ng-template>
</p-table> -->
    <p-table #tt dataKey="id" [columns]="cols" 
      (onEditInit)="onEditInit($event)"   
      (onEditCancel)="onEditCancel($event)" 
      (onEditComplete)="onEditComplete($event)"
      [value]="usersWithSheets" 
      [resizableColumns]="true"   sortOrder="1" 
      loadingIcon="fa fa-spinner" csvSeparator=";" exportFilename="czas_pracy" [globalFilterFields]="cols"
      [responsive]="false"
      
    >
    <ng-template pTemplate="caption">
      <div>
        <i class="fa fa-search"></i>
        <input type="text" pInputText size="50" placeholder="Filtruj"
          (input)="tt.filterGlobal($event.target.value, 'contains')" style="width:auto">
      </div>
    </ng-template>
    <ng-template pTemplate="header" let-columns>
      <tr>
        <th *ngFor="let col of columns" [hidden]="col.hidden" [pSortableColumn]="col.field" [ngClass]="col.class"
          pResizableColumn excludeGlobalFilter=col.exclude>
          <span class="header">
            {{col.header}}
            <p-sortIcon *ngIf="!col.button && col.sortable" [field]="col.field"></p-sortIcon>
          </span>
        </th>
      </tr>
      <tr>
        <th *ngFor="let col of columns" [hidden]="col.hidden">
          <input class="width-100" [attr.placeholder]="col.inOut ? 'Y/N' : 'Filtruj'" pInputText
            type="text" (input)="tt.filter($event.target.value, col.field, col.filterMatchMode)" *ngIf="col.filter">       
        </th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-rowData let-columns="columns" let-expanded="expanded">
       <tr>       
        <td *ngFor="let col of columns"  [pEditableColumn]="col.edit ? rowData : null" [pEditableColumnField]="rowData[col.field]"
          [hidden]="col.hidden" [ngClass]="col.class" >
            <p-cellEditor *ngIf="col.edit" >  
                <ng-template pTemplate="input" *ngIf="user?.roleCode?.indexOf('OP') > -1">
                    <input pInputText type="text" [(ngModel)]="rowData[col.field]" (ngModelChange)="valueChange(rowData)" [style.color]="rowData.color" >
                </ng-template>
                <ng-template pTemplate="output">
                  <span [style.color]="rowData.color" >
                      {{rowData[col.field]}}
                  </span>
                </ng-template>
              </p-cellEditor>
              <span  *ngIf="!col.edit && !col.status">
                  {{rowData[col.field]}}
              </span>             
              <div *ngIf="col.status">
                  <div *ngIf="rowData[col.field] == 'PROGRESS'"  class="text-center"><p-progressSpinner [style]="{width: '30px', height: '30px'}" strokeWidth="2"></p-progressSpinner></div>
                  <div *ngIf="rowData[col.field] == 'OK'"  class="text-center" [style.color]="'green'"><i class="fa fa-check" aria-hidden="true"></i></div>
                  <div *ngIf="rowData[col.field] == 'EDITED'" class="text-center" [style.color]="'#2399e5'"><i class="fa fa-pencil-square-o" aria-hidden="true"></i></div>    
              </div>
              <div *ngIf="col.expand">
                  <a href="#" [pRowToggler]="rowData">
                      <i [ngClass]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></i>
                  </a>
              </div>
        </td>
      </tr> 
    </ng-template>
     <ng-template pTemplate="rowexpansion" let-rowData let-columns="columns">
        <tr>
            <td [attr.colspan]="columns.length + 1">
                <div class="ui-grid ui-grid-responsive ui-fluid" style="font-size:16px;padding:20px">
                    <div class="ui-grid-row">
                      <div *ngIf="rowData?.email" class="ui-grid-col-12" style="text-align:left; font-size: smaller;">
                        Utworzony dla: {{rowData.role}}, {{rowData.email}}, {{rowData.phone}},
                      </div>
                    </div>
                    <div class="ui-grid-row">
                      <div *ngIf="rowData?.copy?.createdBy" class="ui-grid-col-12" style="text-align:left; font-size: smaller;">
                          Utworzony przez: <span style="font-weight: bold">{{rowData.copy.createdBy}}</span>
                      </div>
                    </div>
                    <div class="ui-grid-row">
                      <div *ngIf="rowData?.copy?.modifiedBy" class="ui-grid-col-12" style="text-align:left; font-size: smaller;">
                          Zmodyfikowany przez: <span style="font-weight: bold">{{rowData.copy.modifiedBy}}</span>
                      </div>
                    </div>
                    <div class="ui-grid-row">
                      <div *ngIf="rowData?.copy?.fromIsp || rowData?.copy?.fromOrg" class="ui-grid-col-12" style="text-align:left; font-size: smaller;">
                        Wejście: <span style="font-weight: bold">{{rowData.copy.fromIsp}} @ {{rowData.copy.fromOrg}}, {{rowData.copy.fromCity}} @ {{rowData.copy.fromRegion}}</span>
                      </div>
                    </div>
                    <div class="ui-grid-row">
                      <div *ngIf="rowData?.copy?.toIsp || rowData?.copy?.toOrg" class="ui-grid-col-12" style="text-align:left; font-size: smaller;">
                        Wyjście: <span style="font-weight: bold">{{rowData.copy.toIsp}} @ {{rowData.copy.toOrg}}, {{rowData.copy.toCity}} @ {{rowData.copy.toRegion}}</span>
                      </div>
                    </div>
                  </div>
            </td>
        </tr>
    </ng-template>
     <ng-template pTemplate="footer" let-columns>
      <tr>
        <td *ngFor="let col of columns" [hidden]="col.hidden">
          <span *ngIf="col.training">Suma szkoleń <br /> {{summary?.totalTrainingTimeInGMM}} </span>
          <span *ngIf="col.break">Suma przerw <br /> {{summary?.totalBreakTime}} </span>
          <span *ngIf="col.isLeave">Suma urlop <br /> {{summary?.totalIsLeave}} </span>
          <!-- <span *ngIf="col.header === 'Nazwisko'">Ilość pracowników <br /> {{usersWithSheets?.length}}</span> -->
        </td>
      </tr>
    </ng-template>
    <ng-template pTemplate="summary" let-columns="columns">
      <div class="ui-grid ui-grid-responsive ui-fluid ui-grid-pad">
        <div class="ui-grid-row" style="margin-top: 15px;">
          <div class="ui-grid-col-1"></div>
          <div class="ui-grid-col-2"></div>
          <div class="ui-grid-col-2"></div>
          <div class="ui-grid-col-2"> <button  type="button" pButton
              icon="fa fa-file-o" style="float:left" (click)="tt.exportCSV()" label="CSV"></button> </div>
          <div class="ui-grid-col-2"> </div>
          <div class="ui-grid-col-2"> </div>
          <div class="ui-grid-col-1"> </div>
        </div>
      </div>
    </ng-template>
    <ng-template pTemplate="emptymessage">
      Brak danych...
    </ng-template>
  </p-table>

    <!-- end turbo table -->
  </div>




</p-panel>
