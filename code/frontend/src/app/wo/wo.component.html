

<p-panel header="Zlecenia - WO">

  <div class="ui-grid-row">
    <div class="ui-grid-col-6">
      <p-fieldset legend="Wyszukiwanie zleceń">
        <form #f="ngForm" (submit)="search()">

          <div class="ui-grid ui-grid-responsive ui-fluid ui-grid-pad">
            <div class="ui-grid-row"  style="margin-top: 20px;">
              <div class="ui-grid-col-1"></div>
              <div class="ui-grid-col-5">
                <label for="lastModAfter">zmodyfikowano od</label>
                <p-calendar name="lastModAfter" [(ngModel)]="lastModAfter" showIcon="true" dateFormat="dd.mm.yy" utc="true"></p-calendar>
              </div>
              <!--<div class="ui-grid-col-1"></div>-->
              <div class="ui-grid-col-5">
                <label for="lastModBefore">zmodyfikowano do</label>
                <p-calendar name="lastModBefore" [(ngModel)]="lastModBefore"showIcon="true" dateFormat="dd.mm.yy" utc="true"></p-calendar>
              </div>
              <div class="ui-grid-col-1"></div>
            </div>
            <div class="ui-grid-row"  style="margin-top: 15px;">
              <div class="ui-grid-col-4"></div>
              <div class="ui-grid-col-4">
                <button pButton type="button" (click)="search()" icon="fa-search" label="Szukaj Tena" style="margin-left: 0px; min-width: 140px;" [disabled]="!f?.valid"></button>
              </div>
              <div class="ui-grid-col-4"></div>
            </div>
          </div>
        </form>
      </p-fieldset>
    </div>

    <div class="ui-grid-col-6">
      <app-status-details></app-status-details>
    </div>

  </div>

  <div style="margin-top: 5px" *ngIf="orders" class="ui-g">
    <p-contextMenu #cm [model]="items"></p-contextMenu>

    <p-dataTable [value]="orders" [rows]="20" [paginator]="true" [globalFilter]="gb" #dt selectionMode="single" [(selection)]="selectedOrder" (onRowSelect)="onRowSelect($event)" (onRowDblclick)="onRowDblclick($event)" dataKey="id" resizableColumns="true" sortField="lastModDate" sortOrder="-1" [loading]="loading" loadingIcon="fa-spinner" [contextMenu]="cm">
      <p-header>
        <div>
          <i class="fa fa-search"></i>
          <input #gb type="text" pInputText size="50" placeholder="Filtruj">
          <button type="button" pButton icon="fa-plus" style="float:left" (click)="add()" label="Dodaj"></button>
        </div>
      </p-header>
      <p-column [sortable]="true" field="id" header="id" hidden="true" ></p-column>
      <p-column [sortable]="true" field="workNo" header="WO" ></p-column>

      <p-column [sortable]="true" field="status" header="statusSearch" [style]="{'width':'0px'}" hidden="true"></p-column><!-- search -->
      <p-column [sortable]="true" field="statusCode" header="Status" [style]="{'width':'135px'}">
        <ng-template let-col let-order="rowData" pTemplate="body">
          <span class="ui-inputgroup-addon"><i [class]="toolsService.getStatusIcon(order.statusCode)"></i></span>
          <span style="padding: 3px">{{order.status}}</span>
        </ng-template>
      </p-column>

      <p-column [sortable]="true" field="type" header="typeSearch" [style]="{'width':'0px'}"></p-column><!-- search -->
      <p-column [sortable]="true" field="typeCode" header="Typ">
        <ng-template let-col let-order="rowData" pTemplate="body">
          <span [style.color]="toolsService.getOrderColor(order.typeCode)" class="ui-inputgroup-addon"><i [class]="'fa fa-square'"></i></span>
          <span style="padding: 3px">{{order.type}}</span>
        </ng-template>
      </p-column>

      <p-column [sortable]="true" field="complexityCode" header="Zł." [style]="{'text-align':'center', 'width':'45px'}">
        <ng-template let-col let-order="rowData" pTemplate="body">
          <span class="ui-inputgroup-addon"><i [class]="order[col.field]=='STD' ? 'fa fa-thumbs-o-up': 'fa fa-life-bouy'"></i></span>
        </ng-template>
      </p-column>

      <p-column [sortable]="true" field="mdCapex" header="CAPEX" ></p-column>
      <p-column [sortable]="true" field="price" header="Cena" styleClass="text-right" [style]="{'width':'70px'}"></p-column>

      <p-column [sortable]="true" field="comment" header="Komentarz" hidden="true"></p-column>
      <p-column [sortable]="true" field="description" header="Opis" hidden="true"></p-column>

      <p-column [sortable]="true" field="assignee" header="Wykonawca"></p-column><!--this is array -->
      <p-column [sortable]="true" field="protocolNo" header="Protokół"></p-column>
      <p-column [sortable]="true" field="lastModDate" header="Mod." [style]="{'width':'82px'}"></p-column>
      <p-column [sortable]="true" field="creationDate" header="Utw." [style]="{'width':'82px'}"></p-column>

      <p-column [sortable]="true" field="itemNo" header="Numer obiektu" ></p-column>
      <!-- search by invisible colums flatten into order by wo.service -->
      <p-column [sortable]="true" field="itemBuildingType" header="Typ obiektu" hidden="true"></p-column>
      <p-column [sortable]="true" field="itemConstructionCategory" header="Konstukcja" hidden="true"></p-column>
      <p-column [sortable]="true" field="itemAddress" header="Adres" hidden="true"></p-column>
      <p-column [sortable]="true" field="itemDescription" header="Opis obiektu" hidden="true"></p-column>

      <!-- these are original childobject props but could not be used to filter
      <p-column [sortable]="true" header="Obiekt">
        <ng-template let-col let-relatedItem="rowData.relatedItems[0]" pTemplate="body">
          <span *ngIf="relatedItem?.itemNo">{{relatedItem?.itemNo}}<br></span>
          <span *ngIf="relatedItem?.address">{{relatedItem?.address}}<br></span>
          <span *ngIf="relatedItem?.mdBuildingType">{{relatedItem?.mdBuildingType}}<br></span>
          <span *ngIf="relatedItem?.mdConstructionCategory">{{relatedItem?.mdConstructionCategory}}<br></span>
          <span *ngIf="relatedItem?.description">{{relatedItem?.description}}<br></span>
        </ng-template>
      </p-column>-->
      <p-column [sortable]="true" field="ventureCompany" header="Inwestor" ></p-column>
      <p-column [sortable]="true" field="ventureDisplay" header="Przedstawiciel" ></p-column>
      <p-column [style]="{'width':'40px','text-align':'center'}">
        <ng-template let-order="rowData" pTemplate="body">
          <button type="button" pButton (click)="selectedOrder=order; onRowSelect($event); displayDetailsDialog=true" icon="fa-search"></button>
        </ng-template>
      </p-column>

      <p-footer>
        <div class="ui-grid ui-grid-responsive ui-fluid ui-grid-pad">
          <div class="ui-grid-row"  style="margin-top: 15px;">
            <div class="ui-grid-col-1"></div>
            <div class="ui-grid-col-2">
              <button type="button" pButton icon="fa-plus" style="float:left" (click)="add()" label="Dodaj"></button>
            </div>

            <div class="ui-grid-col-6"></div>

            <div class="ui-grid-col-2">
              <button type="button" pButton icon="fa-file-o" iconPos="left" label="CSV" (click)="dt.exportCSV()"></button>
            </div>
            <div class="ui-grid-col-1"></div>
          </div>
        </div>
      </p-footer>

    </p-dataTable>
  </div>

  <p-dialog [(visible)]="displayDetailsDialog" [header]="'Zamowienie '+selectedOrder?.workNo" [minWidth]="600" [responsive]="true" showEffect="fade" [modal]="true">
    <app-wo-details [selectedOrder]="selectedOrder"></app-wo-details>
  </p-dialog>


  <p-dialog [header]="newOrder? 'Nowe zlecenie' : 'Modyfikacja zlecenia'" [(visible)]="displayEditDialog" [responsive]="true" showEffect="fade" [modal]="true" [minWidth]="800">
    <div class="ui-grid ui-grid-responsive ui-fluid" *ngIf="editedOrder">
      <div class="ui-grid-row" style="margin-top: 10px;">
        <div class="ui-grid-col-4"><label for="ventureRepresentative">Zleceniodawca</label></div>
        <div class="ui-grid-col-8">
          <p-autoComplete id="ventureRepresentative" [(ngModel)]="assignedVentureRepresentative" [suggestions]="suggestedVentureRepresentatives" (completeMethod)="suggestVentureRepresentative($event)" [dropdown]="true" field="displayName" ></p-autoComplete> <!-- [forceSelection]="true" -->
        </div>
      </div>
      <hr>

      <div class="ui-grid-row" style="margin-top: 10px;">
        <div class="ui-grid-col-4"><label for="workNo">Numer WO*</label></div>
        <div class="ui-grid-col-8 ui-fluid"><input pInputText id="workNo" [(ngModel)]="editedOrder.workNo" width="auto" [required]="true" minlength="2" pTooltip="Uzupełnij jeśli posiadzasz numer zlecenia w innym przypadku pozostaw wartość XXXXX" tooltipPosition="top"/></div>
      </div>
      <div class="ui-grid-row" style="margin-top: 10px;">
        <div class="ui-grid-col-4"><label for="orderType">Typ WO*</label></div>
        <div class="ui-grid-col-8">
          <!-- TODO bug [forceSelection]="true" -->
            <p-autoComplete id="orderType" [(ngModel)]="workType" [suggestions]="suggestedTypes" (completeMethod)="suggestType($event)" [dropdown]="true" field="paramChar" required placeholder="Wybierz typ zlecenia..."></p-autoComplete>
        </div>
      </div>
      <div *ngIf="operator.roleCode === 'PR' || editedOrder?.typeCode != 'OT'" class="ui-grid-row" style="margin-top: 10px;">
        <div class="ui-grid-col-4"><label for="price">Wartość zlecenia (PLN)</label></div>
        <div class="ui-grid-col-8">
          <p-autoComplete id="price" [(ngModel)]="price" [suggestions]="suggestedPrice" (completeMethod)="suggestPrice($event)" [dropdown]="true" field="paramChar" [forceSelection]="false" placeholder="Można zmienić cenę (podaj liczbę)"></p-autoComplete>
        </div>
      </div>
        
      <div class="ui-grid-row" *ngIf="newOrder == false" style="margin-top: 10px;"><!-- editing status is not allowed for new orders-->
            <div class="ui-grid-col-4"><label for="status">Status</label></div>
            <div class="ui-grid-col-8">
                <p-autoComplete id="status" [(ngModel)]="status" [suggestions]="suggestedStatuses" (completeMethod)="suggestStatus($event)" [dropdown]="true" field="paramChar" [forceSelection]="true"></p-autoComplete>
            </div>
      </div>
      <div class="ui-grid-row" style="margin-top: 10px;">
        <div class="ui-grid-col-4"><label for="mdCapex">Capex</label></div>
        <div class="ui-grid-col-8"><input pInputText id="mdCapex" [(ngModel)]="editedOrder.mdCapex" placeholder="nr wydatków związanych z rozwojem"/></div>
      </div>
      <div class="ui-grid-row" style="margin-top: 10px;">
        <div class="ui-grid-col-4"><label for="comment">Komentarz</label></div>
        <div class="ui-grid-col-8">
          <!--<input pInputText id="comment" [(ngModel)]="editedOrder.comment" />-->
          <textarea pInputTextarea id="comment" [(ngModel)]="editedOrder.comment" [rows]="2" [cols]="30"  autoResize="autoResize" placeholder="Wewnętrzny komentarz dotyczący WO..."></textarea>
        </div>
      </div>
      <div class="ui-grid-row" style="margin-top: 10px;">
        <div class="ui-grid-col-4"><label for="description">Opis</label></div>
        <div class="ui-grid-col-8">
          <!--<input pInputText id="description" [(ngModel)]="editedOrder.description" />-->
          <textarea pInputTextarea id="description" [(ngModel)]="editedOrder.description"  placeholder="Opis dotyczący WO..." [rows]="2" [cols]="30"  autoResize="autoResize"></textarea>
        </div>
      </div>
      <hr>
      <!-- related item -->

      <div class="ui-grid-row" style="margin-top: 10px;">
        <div class="ui-grid-col-4"><label for="itemNo">Numer obiektu</label></div>
        <div class="ui-grid-col-8">
          <p-autoComplete placeholder="Numer obiektu np. stacji/kandydata" pTooltip="Uzupełnij nowy obiekt lub wybierz istniejący z listy i ew. modyfikuj. Możesz też przypisać później/Możesz zmienić później" id="itemNo" [(ngModel)]="relatedItem" [suggestions]="suggestedRelatedItems" (onBlur)="updateRelatedItem($event.target.value)" (onKeyUp)="updateRelatedItem($event.target.value)" (onFocus)="copyRelatedItem($event.target.value)" (completeMethod)="suggestRelatedItem($event)" [dropdown]="true" field="itemNo" [forceSelection]="false"></p-autoComplete>
        </div>
      </div>
      <div *ngIf="relatedItem?.id && isRelatedItemChanged(relatedItem)" class="ui-grid-row" style="margin-top: 0px;" >
        <div class="ui-grid-col-4"></div>
        <div class="ui-grid-col-8">
          <p-message severity="warn" text="Modyfikacja istniejącego obiektu"></p-message>
        </div>
      </div>
      <div *ngIf="relatedItem?.itemNo !== undefined && relatedItem?.id === undefined" class="ui-grid-row" style="margin-top: 0px;" >
        <div class="ui-grid-col-4"></div>
        <div class="ui-grid-col-8">
          <p-message severity="info" text="Dodawanie nowego obiektu"></p-message>
        </div>
      </div>


      <div class="ui-grid-row" style="margin-top: 10px;">
        <div class="ui-grid-col-4"><label for="itemAddress">Adres</label></div>
        <div class="ui-grid-col-8"><input pInputText id="itemAddress" [(ngModel)]="relatedItem.address" placeholder="Adres objektu inwestycji"/></div>
      </div>
      <div class="ui-grid-row" style="margin-top: 10px;">
        <div class="ui-grid-col-4"><label for="itemBuildingType">Typ budynku</label></div>
        <div class="ui-grid-col-8"><input pInputText id="itemBuildingType" [(ngModel)]="relatedItem.mdBuildingType" placeholder="Typ budynku..."/></div>
      </div>
      <div class="ui-grid-row" style="margin-top: 10px;">
        <div class="ui-grid-col-4"><label for="itemConstructionCategory">Konstrukcja</label></div>
        <div class="ui-grid-col-8"><input pInputText id="itemConstructionCategory" [(ngModel)]="relatedItem.mdConstructionCategory" placeholder="Typ konstrukcji..." /></div>
      </div>
      <div class="ui-grid-row" style="margin-top: 10px;">
        <div class="ui-grid-col-4"><label for="itemDescription">Opis obiektu</label></div>
        <div class="ui-grid-col-8">
          <textarea pInputTextarea id="itemDescription" [(ngModel)]="relatedItem.description" [rows]="2" [cols]="30"  autoResize="autoResize" placeholder="Opis objektu inwestycji..."></textarea>
        </div>
      </div>

      <div *ngIf="relatedItem?.creationDate" class="ui-grid-row" style="margin-top: 10px;">
        <div class="ui-grid-col-4"><label for="itemCreationDate">Data utworzenia</label></div>
        <input pInputText id="itemCreationDate" disabled="true" [(ngModel)]="relatedItem.creationDate"/>
      </div>

    </div>
    <p-footer>
      <div class="ui-dialog-buttonpane ui-helper-clearfix">
        <button [disabled]="!(editedOrder?.workNo && editedOrder?.workNo.length > 2 && workType?.paramChar && workType?.paramChar?.length > 1)" width="200px" type="button" pButton icon="fa-check" (click)="saveOrder()" label="Zapisz"></button>
      </div>
    </p-footer>
  </p-dialog>


  <p-dialog [header]="isNewOrderOwner ? 'Przypisywanie/przepisywanie zlecenia': 'Dopisywanie do zlecenia'" [(visible)]="displayAssignDialog" [responsive]="true" showEffect="fade" [modal]="true" [minWidth]="400">
    <div class="ui-grid ui-grid-responsive ui-fluid" *ngIf="editedOrder">
        <div class="ui-grid-row" style="margin-top: 20px;">
            <div class="ui-grid-col-4"><label for="person">Osoba</label></div>
            <div class="ui-grid-col-8">
              <p-autoComplete id="person" [(ngModel)]="assignedEngineer" [suggestions]="suggestedEngineers" (completeMethod)="suggestEngineer($event)" [dropdown]="true" field="displayName" [forceSelection]="true"></p-autoComplete>
            </div>
        </div>
        <div *ngIf="isNewOrderOwner && selectedOrder?.assignee !== undefined" class="ui-grid-row" style="margin-top: 0px;" >
          <div class="ui-grid-col-4"></div>
          <div class="ui-grid-col-8">
            <p-message severity="warn" text="Zmiana właściciela zlecenia..."></p-message>
          </div>
        </div>

        <div class="ui-grid-row" style="margin-top: 20px;">
            <div class="ui-grid-col-4"><label for="workNo">Numer WO</label></div>
            <div class="ui-grid-col-8"><input pInputText id="workNo" [(ngModel)]="editedOrder.workNo" disabled="true"/></div>
        </div>
        <div class="ui-grid-row" style="margin-top: 20px;">
            <div class="ui-grid-col-4"><label for="type">Typ WO</label></div>
            <div class="ui-grid-col-8"><input pInputText id="type" [(ngModel)]="editedOrder.type" disabled="true"/></div>
        </div>
      <div class="ui-grid-row" style="margin-top: 20px;">
        <div class="ui-grid-col-4"><label for="status">Status</label></div>
        <div class="ui-grid-col-8">
          <div class="ui-grid-col-8"><input pInputText id="status" [(ngModel)]="editedOrder.status" disabled="true"/></div>
        </div>
      </div>
    </div>
    <p-footer>
      <div class="ui-dialog-buttonpane ui-helper-clearfix">
        <button width="200px" type="button" pButton [icon]="isNewOrderOwner ? 'fa-user': 'fa-share'" (click)="saveAssignment()" [label]="isNewOrderOwner ? 'Przypisz': 'Dopisz'"></button>
      </div>
    </p-footer>
  </p-dialog>


</p-panel>